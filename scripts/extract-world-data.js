/**
 * Extract accurate world coastline polygons from Natural Earth 110m data
 * Uses world-atlas (TopoJSON) + topojson-client to produce GeoJSON coordinates
 * Output: js/world-data.js with compact polygon arrays for canvas rendering
 */
const topojson = require('topojson-client');
const worldTopo = require('world-atlas/land-110m.json');
const fs = require('fs');
const path = require('path');

// Convert TopoJSON to GeoJSON
const geojson = topojson.feature(worldTopo, worldTopo.objects.land);

// Extract all polygon rings (exterior only — skip holes for visual simplicity)
const polygons = [];

function extractRings(geometry) {
    if (geometry.type === 'Polygon') {
        // geometry.coordinates[0] is exterior ring, rest are holes
        polygons.push(geometry.coordinates[0]);
    } else if (geometry.type === 'MultiPolygon') {
        for (const poly of geometry.coordinates) {
            polygons.push(poly[0]); // exterior ring of each polygon
        }
    }
}

if (geojson.type === 'FeatureCollection') {
    for (const feature of geojson.features) {
        extractRings(feature.geometry);
    }
} else if (geojson.type === 'Feature') {
    extractRings(geojson.geometry);
} else {
    extractRings(geojson);
}

// Round coordinates to 1 decimal place to keep file compact
// At 110m resolution, sub-degree precision is sufficient
const compact = polygons.map(ring =>
    ring.map(([lng, lat]) => [Math.round(lng * 10) / 10, Math.round(lat * 10) / 10])
);

// Count total points
const totalPoints = compact.reduce((sum, ring) => sum + ring.length, 0);

// Generate JS output
const output = `/**
 * Accurate world coastline polygons — Natural Earth 110m simplified
 * Generated by scripts/extract-world-data.js
 * ${compact.length} polygons, ${totalPoints} coordinate points
 * Coordinates: [longitude, latitude] in degrees
 */
var worldPolygons = ${JSON.stringify(compact)};
`;

const outPath = path.join(__dirname, '..', 'js', 'world-data.js');
fs.writeFileSync(outPath, output, 'utf8');
console.log(`Written ${compact.length} polygons (${totalPoints} points) to js/world-data.js`);
console.log(`File size: ${(fs.statSync(outPath).size / 1024).toFixed(1)} KB`);
